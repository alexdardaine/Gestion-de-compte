
<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestion Comptes (Mobile v3.4)</title>
<style>
  :root { --bg:#0f172a; --card:#111827; --muted:#9ca3af; --fg:#e5e7eb; --acc:#22d3ee; }
  html,body { margin:0; padding:0; background:var(--bg); color:var(--fg); font-family: system-ui, sans-serif; }
  .container { padding: 16px; max-width: 900px; margin: 0 auto; }
  h1 { font-size: 20px; margin: 0 0 12px 0; display:flex; gap:10px; align-items:center; }
  .badgeVer { font-size:11px; padding:4px 8px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; color:#a7f3d0; }
  .card { background: var(--card); border-radius: 14px; padding: 12px; box-shadow: 0 6px 20px rgba(0,0,0,.25); }
  .grid { display:grid; gap:10px; }
  .row { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
  label { font-size: 12px; color: var(--muted); }
  input, select, button {
    width: 100%; padding: 12px; border-radius: 12px; border: 1px solid #222;
    background: #0b1220; color: var(--fg); outline: none;
  }
  input:focus, select:focus { border-color: var(--acc); box-shadow: 0 0 0 3px rgba(34,211,238,.15); }
  button { background: linear-gradient(180deg, #1f2937, #0b1220); border:1px solid #1f2937; font-weight: 600; }
  .btn-primary { background: linear-gradient(180deg, #06b6d4, #0891b2); border: none; color:#03141a; }
  .btn-danger { background: linear-gradient(180deg, #dc2626, #991b1b); border: none; }
  .space { height: 12px; }
  .list { display:grid; gap:8px; }
  .item { background:#0b1220; border:1px solid #1f2937; border-radius:12px; padding:10px; display:flex; justify-content:space-between; align-items:center; }
  .pill { font-size:12px; padding:4px 8px; border-radius:999px; background:#111827; border:1px solid #1f2937; color:var(--muted); }
  .muted { color: var(--muted); font-size: 12px; }
  .kpi { display:grid; grid-template-columns: 1fr 1fr; gap:8px; }
  .kpi .card { padding:10px; }
  .kpi .val { font-weight:800; font-size:18px; }
  .badge { background:#065f46; color:#d1fae5; padding:3px 8px; border-radius:999px; font-size:11px; }
  .msg { padding:10px; border-radius:12px; margin-top:8px; display:none; }
  .msg.ok { background:#052e1b; border:1px solid #14532d; color:#bbf7d0; }
  .msg.err { background:#3b0a0a; border:1px solid #7f1d1d; color:#fecaca; }
  .toast { position: fixed; bottom: 16px; left: 50%; transform: translateX(-50%); background:#052e1b; color:#bbf7d0; padding:10px 14px; border-radius:12px; display:none; border:1px solid #14532d; }
  .status { font-size: 12px; color: var(--muted); }
</style>
</head>
<body>
<div class="container">
  <h1>Gestion des comptes — Mobile (25 → 25) <span class="badgeVer">v3.4</span></h1>
  <div id="period" class="muted"></div>
  <div class="status" id="status">Stockage : localStorage</div>
  <div class="space"></div>

  <div class="card grid">
    <div id="msg" class="msg"></div>
    <div class="grid">
      <div>
        <label>Intitulé</label>
        <input id="label" placeholder="Ex : Carrefour, EDF, Remboursement..." />
      </div>
      <div>
        <label>Catégorie</label>
        <select id="category">
          <option value="DEPENSE_PERSO">Dépense Perso</option>
          <option value="DEPENSE_TRAVAIL">Dépense Travail</option>
          <option value="DEPENSE_LOISIR">Dépense Loisir</option>
          <option value="DEPENSE_FAMILLE">Dépense Famille</option>
          <option value="ENTREE_MAISON">Entrée Maison</option>
          <option value="SORTIE_MAISON">Sortie Maison</option>
        </select>
      </div>
      <div>
        <label>Montant (€)</label>
        <input id="amount" type="text" inputmode="decimal" placeholder="0,00" />
      </div>
    </div>
    <div class="row">
      <button class="btn-primary" onclick="onSave()">Enregistrer</button>
      <button onclick="exportCSV()">Exporter CSV (période)</button>
      <button class="btn-danger" onclick="wipeAll()">Tout effacer</button>
      <button onclick="resetCache()">Réinitialiser le cache</button>
    </div>
  </div>

  <div class="space"></div>

  <div class="kpi">
    <div class="card"><div class="muted">Dépense Perso</div><div class="val" id="k_perso">0.00 €</div></div>
    <div class="card"><div class="muted">Dépense Travail</div><div class="val" id="k_travail">0.00 €</div></div>
    <div class="card"><div class="muted">Dépense Loisir</div><div class="val" id="k_loisir">0.00 €</div></div>
    <div class="card"><div class="muted">Dépense Famille</div><div class="val" id="k_famille">0.00 €</div></div>
    <div class="card"><div class="muted">Entrée Maison</div><div class="val" id="k_entree">0.00 €</div></div>
    <div class="card"><div class="muted">Sortie Maison</div><div class="val" id="k_sortie">0.00 €</div></div>
    <div class="card"><div class="muted">Total Dépenses</div><div class="val" id="k_total_dep">0.00 €</div></div>
    <div class="card"><div class="muted">Solde Maison (Entrées − Sorties)</div><div class="val" id="k_solde">0.00 €</div></div>
  </div>

  <div class="space"></div>

  <div class="card">
    <div class="row" style="justify-content:space-between;">
      <div><strong>Saisies de la période</strong></div>
      <div class="pill" id="count">0 ligne</div>
    </div>
    <div class="space"></div>
    <div class="list" id="list"></div>
  </div>

  <div class="toast" id="toast">Enregistré ✔</div>

</div>

<script>
const LS_KEY=(location.origin+location.pathname.toLowerCase()+"_gc_v34").replace(/[^a-z0-9_]/g,"_");
let memoryStore=[];

function status(t){document.getElementById("status").textContent=t;}
function today(){const d=new Date();d.setHours(0,0,0,0);return d;}
function monthNumber(d){return d.getMonth()+1;}
function formatDate(d){const dd=String(d.getDate()).padStart(2,'0');const mm=String(monthNumber(d)).padStart(2,'0');const yyyy=d.getFullYear();return `${dd}/${mm}/${yyyy}`;}
function euro(n){const v=Number(n||0);return v.toFixed(2).replace('.',',')+" €";}
function parseAmount(x){if(x==null)return NaN;let s=String(x).trim();s=s.replace(/[€\s]/g,'');s=s.replace(',','.');if(!/^-?\d+(\.\d+)?$/.test(s))return NaN;return Number.parseFloat(s);}
function buildLocalISO(d){const yyyy=d.getFullYear();const mm=String(d.getMonth()+1).padStart(2,'0');const dd=String(d.getDate()).padStart(2,'0');return `${yyyy}-${mm}-${dd}`;}
function currentPeriod(now=new Date()){const n=new Date(now);n.setHours(0,0,0,0);const start=(n.getDate()>=25)?new Date(n.getFullYear(),n.getMonth(),25):new Date(n.getFullYear(),n.getMonth()-1,25);const end=new Date(start.getFullYear(),start.getMonth()+1,25);return[start,end];}
function filterByPeriod(arr,start,end){const s=start.getTime();const e=end.getTime();return arr.filter(x=>{const[Y,M,D]=(x.dateISO||'').split('-').map(Number);if(!Y||!M||!D)return false;const t=new Date(Y,M-1,D).getTime();return t>=s&&t<e;});}
function displayCat(c){switch(c){case"DEPENSE_PERSO":return"Dépense Perso";case"DEPENSE_TRAVAIL":return"Dépense Travail";case"DEPENSE_LOISIR":return"Dépense Loisir";case"DEPENSE_FAMILLE":return"Dépense Famille";case"ENTREE_MAISON":return"Entrée Maison";case"SORTIE_MAISON":return"Sortie Maison";}return c;}

function load(){try{const raw=localStorage.getItem(LS_KEY);return raw?JSON.parse(raw):memoryStore;}catch(e){status("Stockage : mémoire");return memoryStore;}}
function save(arr){memoryStore=arr.slice();try{localStorage.setItem(LS_KEY,JSON.stringify(arr));status("Stockage : localStorage");}catch(e){status("Stockage : mémoire");}}

function onSave(){
  const label=document.getElementById("label").value.trim();
  const category=document.getElementById("category").value;
  const amt=parseAmount(document.getElementById("amount").value);
  if(!label){alert("Intitulé requis.");return;}
  if(!Number.isFinite(amt)){alert("Montant invalide. Ex: 12,50 ou 12.50");return;}
  const d=today();
  const entry={id:Date.now(),dateISO:buildLocalISO(d),month:monthNumber(d),label,category,amount:amt};
  const data=load();data.unshift(entry);save(data);
  document.getElementById("label").value="";document.getElementById("amount").value="";
  toast("Enregistré ✔");render();
}
function toast(text){const t=document.getElementById("toast");t.textContent=text;t.style.display="block";setTimeout(()=>t.style.display="none",1200);}

function exportCSV(){
  const[start,end]=currentPeriod(new Date());
  const list=filterByPeriod(load(),start,end);
  if(list.length===0){alert("Rien à exporter sur cette période.");return;}
  let csv="Date;Mois;Intitule;Categorie;Montant\n";
  list.forEach(e=>{csv+=`${e.dateISO};${String(e.month).padStart(2,'0')};${e.label};${displayCat(e.category)};${Number(e.amount||0).toFixed(2)}\n`;});
  const blob=new Blob([csv],{type:"text/csv;charset=utf-8"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");a.href=url;a.download="gestion_comptes_periode.csv";
  document.body.appendChild(a);a.click();URL.revokeObjectURL(url);a.remove();
}
function wipeAll(){if(!confirm("Tout effacer ?"))return;save([]);render();alert("Données effacées.");}
function resetCache(){try{localStorage.removeItem(LS_KEY);}catch(e){}memoryStore=[];render();alert("Cache réinitialisé.");}

function render(){
  const[s,e]=currentPeriod(new Date());
  document.getElementById("period").textContent=`Période: ${formatDate(s)} → ${formatDate(new Date(e.getTime()-86400000))}`;
  const data=load();
  const periodData=filterByPeriod(data,s,e);
  const sum=(cat)=>periodData.filter(x=>x.category===cat).reduce((t,x)=>t+Number(x.amount||0),0);
  const dPerso=sum("DEPENSE_PERSO"),dTrav=sum("DEPENSE_TRAVAIL"),dLois=sum("DEPENSE_LOISIR"),dFam=sum("DEPENSE_FAMILLE"),eMaison=sum("ENTREE_MAISON"),sMaison=sum("SORTIE_MAISON");
  document.getElementById("k_perso").textContent=euro(dPerso);
  document.getElementById("k_travail").textContent=euro(dTrav);
  document.getElementById("k_loisir").textContent=euro(dLois);
  document.getElementById("k_famille").textContent=euro(dFam);
  document.getElementById("k_entree").textContent=euro(eMaison);
  document.getElementById("k_sortie").textContent=euro(sMaison);
  document.getElementById("k_total_dep").textContent=euro(dPerso+dTrav+dLois+dFam);
  document.getElementById("k_solde").textContent=euro(eMaison-sMaison);
  const listEl=document.getElementById("list"),countEl=document.getElementById("count");
  countEl.textContent=`${periodData.length} ${periodData.length>1?"lignes":"ligne"}`;
  listEl.innerHTML="";
  periodData.forEach(e=>{
    const[Y,M,D]=(e.dateISO||"").split("-").map(Number);
    const d=new Date(Y||1970,(M||1)-1,D||1);
    const div=document.createElement("div");div.className="item";
    div.innerHTML=`<div><div><strong>${e.label}</strong></div><div class="muted">${formatDate(d)} — Mois: ${String(e.month||0).padStart(2,'0')} — ${displayCat(e.category)}</div></div><div><span class="badge">${euro(Number(e.amount||0))}</span></div>`;
    listEl.appendChild(div);
  });
}
render();
</script>
</body>
</html>
